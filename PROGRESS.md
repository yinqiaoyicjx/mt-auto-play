# 魔塔自动游玩脚本 - 项目进度

## 项目概述

基于图像识别的《魔塔24层》自动游玩Python脚本，使用图像识别 + 键盘控制方案。

## 当前进度

### ✅ 已完成（2025-02-12 更新）

#### 核心框架
- [x] 项目目录结构创建（src/ 和 scripts/ 分离）
- [x] 核心模块框架搭建
  - [x] `capture.py` - 屏幕截图模块（窗口大小固定、手动区域选择）
  - [x] `detector.py` - 游戏元素识别（含可视化调试）
  - [x] `state.py` - 游戏状态管理（含存档/读取）
  - [x] `planner.py` - 路径规划和决策
  - [x] `controller.py` - 键盘控制执行（含重试机制）
  - [x] `main.py` - 命令行模式主程序
  - [x] `resource_manager.py` - 资源管理与决策（核心）
  - [x] `shop.py` - 商店购买决策

#### GUI图形界面 ⭐新增
- [x] `gui_launcher.py` - 图形界面启动器
  - 实时游戏画面预览（416x416）
  - 开始/暂停/停止控制
  - 游戏状态实时显示（楼层、生命、攻防、金币、钥匙）
  - 当前决策内容和原因显示
  - 决策详情显示（动作、目标、消耗、收益）
  - 活动日志输出
  - 调试模式可视化（检测框、网格线）
  - 手动截图区域选择
  - 界面完全中文化

#### 数据持久化系统 ⭐新增
- [x] 游戏存档系统
  - 3个存档槽位
  - 快速保存功能
  - 自动保存（每50步、切换楼层、停止时）
  - 存档信息显示

- [x] 游戏基础数据库系统 ⭐新增
  - `game_database.py` - 完整数据库模块
  - 地图结构保存（网格、怪物、门、钥匙、楼梯）
  - 怪物属性保存（位置、名称、攻防血金）
  - 自动记录探索数据
  - 数据库查看/导出/重置功能
  - 支持断点续玩

#### 工具集和脚本
- [x] `tools.py` - 工具集
  - 怪物模板手动收集
  - 从怪物手册自动收集
  - 窗口大小调整（640x480）
  - 网格校准
  - 检测功能测试
- [x] `install.bat` - 依赖安装脚本
- [x] `check.bat` - 系统环境检查
- [x] `start.bat` - 命令行模式启动
- [x] `start_debug.bat` - 调试模式启动
- [x] `start_gui.bat` - GUI模式启动 ⭐推荐
- [x] `tools.bat` - 工具集菜单

#### 文档
- [x] `README.md` - 完整使用说明
- [x] `config.py` - 配置文件
- [x] `requirements.txt` - Python依赖列表
- [x] `data/monsters.json` - 怪物数据库模板

### 🚧 进行中

- [ ] 实际游戏测试和调试
- [ ] 怪物模板收集（依赖游戏运行）
- [ ] 检测参数优化
- [ ] 决策算法调优

### 📋 待开发

- [ ] 状态栏OCR识别（玩家属性）
- [ ] 完整的商店界面检测
- [ ] 多楼层联合路径规划
- [ ] 动态难度策略调整
- [ ] 录制回放功能完善
- [ ] 性能优化（帧率、内存）

## 技术架构

```
┌─────────────────────────────────────────┐
│           Game Window (魔塔)             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         ScreenCapture (截图)             │
│  - 自动窗口定位和大小固定                │
│  - 手动区域选择（支持分屏调试）          │
│  - 线程安全的mss截图                     │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│    GameElementDetector (目标检测)         │
│  - 怪物位置（模板匹配 + 调试可视化）    │
│  - 门/钥匙（HSV颜色识别）                │
│  - 玩家位置（蓝色检测 + 调试框）          │
│  - 楼梯位置（边缘检测）                   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        GameDatabase (游戏数据库) ⭐新增  │
│  - 地图结构（网格数据）                  │
│  - 怪物信息（位置、属性）                 │
│  - 门/钥匙/楼梯位置                      │
│  - 已探索区域记录                        │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│       GameState (游戏状态管理)            │
│  - 玩家属性（攻防血、钥匙、金币）         │
│  - 楼层状态（已访问区域、元素位置）       │
│  - 存档/读取功能                         │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│     ResourceManager (资源决策) ★核心       │
│  - 全局资源评估                          │
│  - 战斗价值计算                          │
│  - 钥匙分配策略                          │
│  - 商店购买决策                          │
│  - 目标导向规划                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│        GamePlanner (路径规划)            │
│  - BFS/A* 寻路                           │
│  - 约束条件检查                          │
│  - 最优路径计算                          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      SmartController (控制执行)           │
│  - 键盘输入                              │
│  - 重试机制（最多3次）                   │
│  - 延迟控制                              │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          GUI Launcher (图形界面) ⭐新增   │
│  - 实时画面预览                          │
│  - 检测调试可视化                        │
│  - 游戏状态显示                          │
│  - 决策过程展示                          │
│  - 存档管理（3槽位）                     │
│  - 数据库管理                            │
└─────────────────────────────────────────┘
```

## 关键功能特性

### 1. 双模式截图
- **自动模式**：自动定位游戏窗口，固定大小
- **手动模式**：手动选择截图区域，支持分屏调试

### 2. 可视化调试
- 实时游戏画面预览
- 玩家检测框（绿色轮廓+边界框+中心点）
- 网格辅助线
- 检测不到玩家时红色警告

### 3. 存档系统
- 3个独立存档槽
- 自动保存（定期/换楼层/停止时）
- 存档信息显示（楼层、生命、攻击、金币、时间）

### 4. 游戏数据库
- 探索数据自动保存
- 地图结构持久化
- 怪物/物品位置记录
- 支持3个存档槽独立存储
- 数据库查看/导出/重置

## 核心待解决问题

### 1. 怪物模板收集 ⚠️ 优先级高

**当前状态**：检测框架已就绪，需要收集实际游戏模板

**解决方案**：
1. 运行 `tools.bat`
2. 选择功能2（从怪物手册收集）
3. 打开游戏内怪物手册
4. 自动截取所有怪物图片
5. 关联怪物属性数据

### 2. 玩家检测优化

**当前状态**：使用蓝色HSV检测，可能不够准确

**改进方案**：
- 添加玩家模板支持
- 支持手动标注玩家位置
- 多种检测方法结合

### 3. 资源分配决策

**当前状态**：框架已搭建，需要实战测试

**魔塔游戏特点**：
- 攻击力 > 怪物防御力才能造成伤害
- 钥匙有限，需要合理分配
- 商店物品性价比不同
- 最终Boss需要特定属性才能战胜

**核心算法**：
```python
# 战斗价值计算
def calculate_combat_value(player, monster):
    hp_cost = simulate_battle(player, monster)
    if hp_cost >= player.hp:
        return -∞  # 无法战胜
    return (monster.gold + future_benefit) / hp_cost

# 钥匙分配策略
def plan_key_usage(state, target_floor):
    # 计算到达目标楼层需要哪些钥匙
    # 评估开门后的预期收益
    # 优化钥匙使用顺序
```

## 已解决的技术难点

### 1. mss线程安全 ✅
- **问题**：`'_thread._local' object has no attribute 'srcdc'`
- **解决**：每次capture()创建新mss实例，添加threading.Lock()

### 2. tkinter线程安全 ✅
- **问题**：UI从后台线程更新导致崩溃
- **解决**：使用root.after()在主线程中更新UI

### 3. 手动区域窗口激活 ✅
- **问题**：手动模式下游戏窗口失去焦点
- **解决**：添加自动激活游戏窗口功能

### 4. 中文编码问题 ✅
- **问题**：批处理文件中文乱码
- **解决**：移除chcp 65001，使用纯英文脚本

## 文件清单

```
mota/
├── scripts/                    # 启动脚本
│   ├── start_gui.bat          # GUI模式启动 ⭐推荐
│   ├── start.bat              # 命令行模式
│   ├── start_debug.bat        # 调试模式
│   ├── tools.bat              # 工具集菜单
│   ├── install.bat            # 安装依赖
│   └── check.bat              # 系统检查
│
├── src/                        # 源代码
│   ├── gui_launcher.py        # GUI启动器 ⭐新增（~700行）
│   ├── game_database.py       # 游戏数据库 ⭐新增（~280行）
│   ├── capture.py              # 屏幕截图（~250行）
│   ├── detector.py             # 元素检测（~450行）
│   ├── state.py                # 状态管理（~430行）
│   ├── planner.py              # 路径规划（~490行）
│   ├── controller.py           # 键盘控制（~330行）
│   ├── resource_manager.py     # 资源管理（~860行）
│   ├── shop.py                 # 商店分析（~450行）
│   ├── tools.py                # 工具集（~410行）
│   ├── config.py               # 配置文件
│   └── main.py                 # 命令行入口
│
├── data/
│   ├── game_database.json      # 游戏数据库 ⭐新增
│   ├── monsters.json            # 怪物数据库
│   ├── saves/                   # 存档目录 ⭐新增
│   │   ├── save_1.json
│   │   ├── save_2.json
│   │   └── save_3.json
│   └── templates/               # 怪物模板
│
├── logs/                       # 日志和录制
├── requirements.txt            # Python依赖
├── README.md                   # 使用说明
└── PROGRESS.md                 # 项目进度（本文件）
```

## 开发计划

### Phase 1: 基础框架 ✅ 已完成
- [x] 项目框架搭建
- [x] 核心模块实现
- [x] GUI图形界面
- [x] 存档系统
- [x] 数据库系统

### Phase 2: 测试和调优 🚧 当前
- [ ] 怪物模板收集
- [ ] 游戏实际测试
- [ ] 检测参数优化
- [ ] 决策算法测试

### Phase 3: 高级功能 📋 待开发
- [ ] 状态栏OCR识别
- [ ] 商店界面检测
- [ ] 多楼层联合规划
- [ ] 动态策略调整
- [ ] 性能优化

## 测试记录

| 日期 | 测试内容 | 结果 | 备注 |
|------|----------|------|------|
| 2025-02-12 | GUI启动测试 | ✅ 通过 | 界面正常显示 |
| 2025-02-12 | 数据库模块测试 | ✅ 通过 | 保存/加载正常 |
| 2025-02-12 | 可视化调试测试 | ✅ 通过 | 检测框显示正常 |
| 2025-02-12 | 存档系统测试 | ✅ 通过 | 3槽位读写正常 |
| - | 实际游戏测试 | ⏳ 待测试 | 需要游戏运行 |

## 变更日志

### 2025-02-12
- ✅ 添加GUI图形界面（gui_launcher.py，~700行）
  - 实时画面预览
  - 游戏状态显示
  - 决策过程可视化
  - 存档管理界面
  - 完全中文化界面

- ✅ 添加游戏数据库系统（game_database.py，~280行）
  - 地图结构保存
  - 怪物/物品记录
  - 数据持久化
  - 查看/导出/重置功能

- ✅ 增强state.py存档功能
  - 完整游戏状态保存
  - 怪物/门/钥匙/楼梯信息
  - 存档信息查询

- ✅ 添加可视化调试功能
  - 玩家检测框显示（绿色）
  - 网格辅助线
  - 检测失败警告

- ✅ 完善批处理脚本
  - 修复中文编码问题
  - 添加GUI启动脚本

### 2025-02-11
- ✅ 创建项目框架
- ✅ 实现核心模块
- ✅ 添加工具集脚本
- ✅ 创建进度文档

## 使用的魔塔游戏版本

- **推荐**：网页版魔塔24层
- **分辨率**：640x480 或 800x600
- **窗口标题**：魔塔 / MOTA / magic
- **语言**：中文或英文版均可

## 下一步计划

1. **优先级1**：收集怪物模板
   - 启动游戏
   - 运行 `tools.bat` → 功能2
   - 打开游戏内怪物手册
   - 自动收集所有怪物

2. **优先级2**：实际游戏测试
   - 启动GUI `start_gui.bat`
   - 选择截图区域（或自动模式）
   - 点击"开始"进行自动游玩
   - 观察决策过程，记录问题

3. **优先级3**：优化检测和决策
   - 根据测试结果调整参数
   - 优化玩家检测
   - 调整决策权重

## 参考资料

- [魔塔游戏](https://www.baidu.com/s?wd=魔塔24层)
- [OpenCV文档](https://docs.opencv.org/)
- [Python GUI设计](https://docs.python.org/3/library/tkinter.html)
- [线程安全编程](https://docs.python.org/3/library/threading.html)
